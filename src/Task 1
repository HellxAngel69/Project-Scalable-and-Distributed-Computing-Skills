# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Q4JA-cfEOeAQ_fQcXP8n38Mje5s_XbCM

**1 - Import & Load data (Pandas)**
"""

import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

url = "https://drive.google.com/uc?export=download&id=1d4GYM9oYttQnwK2L8lBgKaG0wFx3FB0X"
df = pd.read_csv(url)
df.head()

"""**2 - Create Spark Session, Convert Pandas â†’ Spark DataFrame and Explore dataset**"""

from pyspark.sql import SparkSession

spark = SparkSession.builder \
    .appName("CustomerData-DataFrame") \
    .getOrCreate()
spark_df = spark.createDataFrame(df)
spark_df.show(5)

spark_df.printSchema()

print("Rows:", spark_df.count())
print("Columns:", len(spark_df.columns))

spark_df.describe().show()

"""**3 - Check and handle missing values**

"""

from pyspark.sql.functions import col, when, trim

spark_df = spark_df.withColumn(
    "TotalCharges",
    when(trim(col("TotalCharges")) == "", None)
    .otherwise(col("TotalCharges"))
)

spark_df = spark_df.withColumn(
    "TotalCharges",
    col("TotalCharges").cast("double")
)

from pyspark.sql.functions import col, sum

spark_df.select([
    sum(col(c).isNull().cast("int")).alias(c)
    for c in spark_df.columns
]).show()

from pyspark.sql.functions import avg

mean_tenure = spark_df.select(avg("tenure")).first()[0]
mean_monthly = spark_df.select(avg("MonthlyCharges")).first()[0]
mean_total = spark_df.select(avg("TotalCharges")).first()[0]

df_clean = spark_df.fillna({
    "tenure": mean_tenure,
    "MonthlyCharges": mean_monthly,
    "TotalCharges": mean_total
})

df_clean.select("tenure", "MonthlyCharges", "TotalCharges").show(5)

"""**7 - Encode categorical variables**


"""

from pyspark.ml.feature import StringIndexer

gender_indexer = StringIndexer(
    inputCol="gender",
    outputCol="gender_index"
)

df_indexed = gender_indexer.fit(df_clean).transform(df_clean)

from pyspark.ml.feature import OneHotEncoder

gender_encoder = OneHotEncoder(
    inputCol="gender_index",
    outputCol="gender_vec"
)

df_encoded = gender_encoder.fit(df_indexed).transform(df_indexed)

"""**8 - Assemble & Scale numerical features**


"""

from pyspark.ml.feature import VectorAssembler

assembler = VectorAssembler(
    inputCols=["tenure", "MonthlyCharges", "TotalCharges"],
    outputCol="numerical_features"
)

df_features = assembler.transform(df_encoded)
df_features.select("numerical_features").show(5)

from pyspark.ml.feature import StandardScaler

scaler = StandardScaler(
    inputCol="numerical_features",
    outputCol="scaled_features",
    withMean=True,
    withStd=True
)

df_final = scaler.fit(df_features).transform(df_features)
df_final.select("scaled_features", "gender_vec").show(5)
